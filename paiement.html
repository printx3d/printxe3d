<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paiement - Printxe3D</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    body { background: #13150C; color: #fff; font-family: Inter, Arial, sans-serif; margin: 0; }
    .loader {
      color: #fff;
      font-size: 48px;
      width: 1em;
      height: 1em;
      border-radius: 50%;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) translateZ(0);
      text-indent: -9999em;
      animation: mulShdSpin 1.3s infinite linear;
      z-index: 9999;
      display: none;
    }
    @keyframes mulShdSpin {
      0%,100% { box-shadow: 0 -3em 0 0.2em,2em -2em 0 0em,3em 0 0 -1em,2em 2em 0 -1em,0 3em 0 -1em,-2em 2em 0 -1em,-3em 0 0 -1em,-2em -2em 0 0; }
      12.5% { box-shadow: 0 -3em 0 0,2em -2em 0 0.2em,3em 0 0 0,2em 2em 0 -1em,0 3em 0 -1em,-2em 2em 0 -1em,-3em 0 0 -1em,-2em -2em 0 -1em; }
      25% { box-shadow: 0 -3em 0 -0.5em,2em -2em 0 0,3em 0 0 0.2em,2em 2em 0 0,0 3em 0 -1em,-2em 2em 0 -1em,-3em 0 0 -1em,-2em -2em 0 -1em; }
      37.5% { box-shadow: 0 -3em 0 -1em,2em -2em 0 -1em,3em 0em 0 0,2em 2em 0 0.2em,0 3em 0 0em,-2em 2em 0 -1em,-3em 0em 0 -1em,-2em -2em 0 -1em; }
      50% { box-shadow: 0 -3em 0 -1em,2em -2em 0 -1em,3em 0 0 -1em,2em 2em 0 0em,0 3em 0 0.2em,-2em 2em 0 0,-3em 0em 0 -1em,-2em -2em 0 -1em; }
      62.5% { box-shadow: 0 -3em 0 -1em,2em -2em 0 -1em,3em 0 0 -1em,2em 2em 0 -1em,0 3em 0 0,-2em 2em 0 0.2em,-3em 0 0 0,-2em -2em 0 -1em; }
      75% { box-shadow: 0em -3em 0 -1em,2em -2em 0 -1em,3em 0em 0 -1em,2em 2em 0 -1em,0 3em 0 -1em,-2em 2em 0 0,-3em 0em 0 0.2em,-2em -2em 0 0; }
      87.5% { box-shadow: 0em -3em 0 0,2em -2em 0 -1em,3em 0 0 -1em,2em 2em 0 -1em,0 3em 0 -1em,-2em 2em 0 0,-3em 0em 0 0,-2em -2em 0 0.2em; }
    }
    .container { max-width: 80%; margin: 40px auto; background: #0B0C04; border-radius: 16px; box-shadow: 0 8px 32px #0004; padding: 32px 24px; position: relative; }
    .total-paiement-top {
      position: absolute;
      top: 24px;
      right: 32px;
      text-align: right;
      font-weight: bold;
      color: #D7FF2F;
      font-size: 1.1em;
      margin-top: 0;
      z-index: 10;
      background: #0B0C04;
      border-radius: 10px;
      padding: 12px 18px;
      min-width: 220px;
      box-shadow: 0 2px 8px #0003;
    }
    h2 { color: #D7FF2F; margin-top: 0; }
    .product-summary { display: flex; gap: 18px; align-items: center; margin-bottom: 24px; }
    .product-summary img { width: 80px; height: 80px; object-fit: cover; border-radius: 12px; background: #333; }
    .product-summary .info { flex: 1; }
    .product-summary .info .title { font-weight: bold; font-size: 1.1em; }
    .product-summary .info .price { color: #D7FF2F; font-size: 1.1em; margin-top: 4px; }
    form { display: flex; flex-direction: column; gap: 14px; }
    input, select { padding: 10px; border-radius: 8px; border: none; font-size: 1em; background: #13150C; color: #fff; }
    button { background: #D7FF2F; color: #111; border: none; border-radius: 8px; padding: 12px; font-weight: bold; font-size: 1.1em; cursor: pointer; margin-top: 10px; }
    button:hover { background: #eaff5f; }
    .success { color: #7fff7f; margin-top: 18px; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Paiement de l'article</h2>
    <div id="totalPaiement" class="total-paiement-top">Sous-total : 0,50&nbsp;€<br>Livraison : 4,90&nbsp;€<br><strong>Total à payer : 5,40&nbsp;€</strong></div>
    <div class="product-summary" id="productSummary">
      <!-- Infos produit injectées par JS -->
    </div>
    <div id="payment-request-button" style="margin-bottom:18px;"></div>
    <form id="fakePaymentForm" autocomplete="on" novalidate>
      <fieldset style="border:none;padding:0;margin-bottom:18px;">
        <legend style="font-weight:bold;color:#D7FF2F;margin-bottom:8px;">Adresse de livraison</legend>
        <input type="text" id="prenom" name="prenom" placeholder="Prénom *" required>
        <input type="text" id="nom" name="nom" placeholder="Nom *" required>
        <input type="text" id="adresse" name="adresse" placeholder="Adresse *" required>
        <input type="text" id="cp" name="cp" placeholder="Code postal *" maxlength="10" required pattern="[0-9]{4,10}">
        <input type="text" id="ville" name="ville" placeholder="Ville *" required>
        <input type="email" id="email" name="email" placeholder="Email *" required>
        <input type="tel" id="tel" name="tel" placeholder="Téléphone *" required pattern="[0-9 +().-]{8,20}">
        <div id="addressError" style="color:#ffb4b4;font-size:0.98em;margin-top:6px;display:none;"></div>
      </fieldset>
      <fieldset style="border:none;padding:0;margin-bottom:18px;">
        <legend style="font-weight:bold;color:#D7FF2F;margin-bottom:8px;">Paiement</legend>
        <div id="card-element" style="background:#13150c;padding:12px;border-radius:8px;"></div>
        <div id="card-errors" style="color:#ffb4b4;font-size:0.98em;margin-top:6px;"></div>
      </fieldset>
      <label for="livraison" style="margin-top:10px;font-weight:bold;">Mode de livraison</label>
      <select id="livraison" required style="padding:10px;border-radius:8px;margin-bottom:10px;">
        <option value="locker" data-price="4.9">Locker — 3–5 jours ouvrés — 4,90 €</option>
        <option value="relais" data-price="5.9">Point Relais® — 3–5 jours ouvrés — 5,90 €</option>
        <option value="domicile" data-price="9.9">À domicile — 3–5 jours ouvrés — 9,90 €</option>
      </select>
      <button type="submit">Payer</button>
    </form>
    <button id="backToSite" style="background:#13150C;color:#FFFFFF;margin-top:18px;width:100%;border:none;padding:12px 0;border-radius:8px;font-weight:bold;font-size:1em;cursor:pointer;">Retourner au site web</button>
    <span class="loader" id="loader">Chargement…</span>
    <div class="success" id="successMsg" style="display:none;">Paiement simulé avec succès !</div>
  </div>
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    // Gère achat direct (un article) ou tout le panier
    const productSummary = document.getElementById('productSummary');
    function fmt(n) { return n.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' }); }
    const article = JSON.parse(localStorage.getItem('paiement_article'));
    const panier = JSON.parse(localStorage.getItem('paiement_panier'));
    // Ajout gestion livraison dynamique
    let totalSansLivraison = 0;
    let remisePromo = 0;
    let promoMsg = '';
    // Code promo caché (obfusqué)
    function getHiddenPromo() {
      const p1 = 'Fam';
      const p2 = 'ily';
      const p3 = '10';
      return (p1 + p2 + p3).toLowerCase();
    }
    let promoCode = '';
    try {
      const promoStorage = localStorage.getItem('promoCode');
      if (promoStorage) promoCode = promoStorage.trim();
    } catch(e) {}
    function renderTotal() {
      const livraison = document.getElementById('livraison');
      const livraisonPrice = livraison ? parseFloat(livraison.options[livraison.selectedIndex].getAttribute('data-price')) : 4.9;
      let total = totalSansLivraison;
      remisePromo = 0;
      promoMsg = '';
      const hiddenPromo = getHiddenPromo();
      if (promoCode && promoCode.toLowerCase() === hiddenPromo) {
        remisePromo = 0.1 * totalSansLivraison;
        promoMsg = 'Code promo appliqué : -10%';
        total -= remisePromo;
      }
      total += livraisonPrice;
      const totalDiv = document.getElementById('totalPaiement');
      if (totalDiv) {
        let html = '';
        html += '<span style="color:#fff">Sous-total :</span> <span style="color:#fff">' + fmt(totalSansLivraison) + '</span><br>';
        if (remisePromo) html += '<span style="color:#7fff7f">Remise : -' + fmt(remisePromo) + '</span><br>';
        html += '<span style="color:#fff">Livraison :</span> <span style="color:#fff">' + fmt(livraisonPrice) + '</span><br>';
        html += '<strong style="color:#D7FF2F">Total à payer : ' + fmt(total) + '</strong>';
        if (promoMsg) html += '<br><span style="color:#7fff7f">' + promoMsg + '</span>';
        totalDiv.innerHTML = html;
      }
    }

    if (panier && Array.isArray(panier) && panier.length > 0) {
      // Priorité au panier si présent
      totalSansLivraison = 0;
      productSummary.innerHTML = panier.map(article => {
        totalSansLivraison += (article.price || 0) * (article.qty || 1);
        return `
          <div style="display:flex;align-items:center;gap:18px;margin-bottom:12px;">
            <img src="${article.images && article.images[0] ? article.images[0] : ''}" alt="${article.title}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;background:#333;">
            <div class="info">
              <div class="title">${article.title}${article.color ? ' <span style=\"color:#D7FF2F\">('+article.color+')</span>' : ''}</div>
              <div class="qty">Quantité : ${article.qty || 1}</div>
              <div class="price">${fmt((article.price || 0) * (article.qty || 1))}</div>
            </div>
          </div>
        `;
      }).join('');
      setTimeout(renderTotal, 0);
    } else if (article) {
      // Achat direct d'un seul article
      totalSansLivraison = (article.price || 0) * (article.qty || 1);
      productSummary.innerHTML = `
        <div style="display:flex;align-items:center;gap:18px;margin-bottom:12px;">
          <img src="${article.images && article.images[0] ? article.images[0] : ''}" alt="${article.title}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;background:#333;">
          <div class="info">
            <div class="title">${article.title}${article.color ? ' <span style=\"color:#D7FF2F\">('+article.color+')</span>' : ''}</div>
            <div class="qty">Quantité : ${article.qty || 1}</div>
            <div class="price">${fmt((article.price || 0) * (article.qty || 1))}</div>
          </div>
        </div>
      `;
      setTimeout(renderTotal, 0);
    } else {
      productSummary.innerHTML = '<span style="color:#f55">Aucun article sélectionné.</span>';
      document.getElementById('fakePaymentForm').style.display = 'none';
    }
        // Met à jour le total quand on change le mode de livraison
    document.getElementById('livraison').addEventListener('change', renderTotal);

    // Stripe public key à remplacer par la vôtre
    const stripe = Stripe('pk_test_51SialFF0VU4FX7rqcX0gtwAUiSLLa8lIpoSO64pLyf63xwA6tibgXmz1Il8jbzhfyfDT7kdIBfweKa8gxcaZjbff00u21cVgmg');
    const elements = stripe.elements();

    // --- Apple Pay / Payment Request Button Stripe ---
    let paymentRequest = stripe.paymentRequest({
      country: 'FR',
      currency: 'eur',
      total: {
        label: 'Total à payer',
        amount: Math.round((totalSansLivraison + 4.9) * 100), // valeur par défaut, ajustée dynamiquement
      },
      requestPayerName: true,
      requestPayerEmail: true,
      requestPayerPhone: true,
      requestShipping: false
    });

    const prButton = elements.create('paymentRequestButton', {
      paymentRequest: paymentRequest,
      style: {
        paymentRequestButton: {
          type: 'default',
          theme: 'dark',
          height: '44px',
        }
      }
    });

    paymentRequest.canMakePayment().then(function(result) {
      if (result) {
        document.getElementById('payment-request-button').style.display = 'block';
        prButton.mount('#payment-request-button');
      } else {
        document.getElementById('payment-request-button').style.display = 'none';
      }
    });

    // Met à jour le montant du paymentRequest lors du changement de livraison
    document.getElementById('livraison').addEventListener('change', function() {
      const livraison = document.getElementById('livraison');
      const livraisonPrice = livraison ? parseFloat(livraison.options[livraison.selectedIndex].getAttribute('data-price')) : 4.9;
      let total = totalSansLivraison;
      if (promoCode && promoCode.toLowerCase() === getHiddenPromo()) {
        total -= 0.1 * totalSansLivraison;
      }
      total += livraisonPrice;
      paymentRequest.update({
        total: {
          label: 'Total à payer',
          amount: Math.round(total * 100)
        }
      });
    });

    paymentRequest.on('paymentmethod', async function(ev) {
      // Même logique que submit, mais pour Apple Pay/Google Pay
      let articles = [];
      if (panier && Array.isArray(panier) && panier.length > 0) {
        articles = panier;
      } else if (article) {
        articles = [article];
      }
      let totalSansLivraison_ = 0;
      articles.forEach(a => { totalSansLivraison_ += (a.price || 0) * (a.qty || 1); });
      let remisePromo_ = 0;
      if (promoCode && promoCode.toLowerCase() === getHiddenPromo()) {
        remisePromo_ = 0.1 * totalSansLivraison_;
      }
      const livraisonSel = document.getElementById('livraison');
      const livraisonPrice_ = livraisonSel ? parseFloat(livraisonSel.options[livraisonSel.selectedIndex].getAttribute('data-price')) : 4.9;
      let total_ = totalSansLivraison_ - remisePromo_ + livraisonPrice_;
      let email_ = ev.payerEmail || '';
      // Appel serveur pour créer PaymentIntent Stripe
      let clientSecret_;
      try {
        const res = await fetch('https://printxe3d.onrender.com/create-payment-intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: Math.round(total_ * 100), currency: 'eur', description: 'Paiement Printxe3D', email: email_ })
        });
        const data = await res.json();
        clientSecret_ = data.clientSecret;
      } catch (err) {
        ev.complete('fail');
        alert('Erreur serveur paiement.');
        return;
      }
      // Confirmer le paiement Stripe
      const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret_, {
        payment_method: ev.paymentMethod.id,
        payment_method_options: { card: { request_three_d_secure: 'any' } },
        receipt_email: email_,
      }, { handleActions: false });
      if (error) {
        ev.complete('fail');
        alert(error.message);
        return;
      }
      ev.complete('success');
      // Paiement réussi : stocker la commande et rediriger
      let note = '';
      try { note = localStorage.getItem('noteCommande') || ''; } catch(e) {}
      function genCommandeNum() {
        const t = Date.now();
        const r = Math.floor(Math.random()*1000);
        return `PX3D-${t}-${r}`;
      }
      let fiche = {
        prenom: ev.payerName || '',
        nom: '',
        adresse: '',
        cp: '',
        ville: '',
        email: email_,
        tel: ev.payerPhone || '',
        livraison: livraisonSel.options[livraisonSel.selectedIndex].text.split('—')[0].trim(),
        articles,
        total: total_.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' }),
        note: note,
        numeroCommande: genCommandeNum(),
        stripePaymentId: paymentIntent.id
      };
      localStorage.setItem('fiche_commande', JSON.stringify(fiche));
      if (article) {
        localStorage.removeItem('paiement_article');
      } else if (panier && Array.isArray(panier)) {
        localStorage.removeItem('cart');
        localStorage.removeItem('paiement_panier');
      }
      localStorage.removeItem('promoCode');
      localStorage.removeItem('noteCommande');
      window.location.href = 'fiche-commande.html';
    });

    // --- Fin Apple Pay ---

    const card = elements.create('card', {
      style: {
        base: {
          fontSize: '16px',
          color: '#FFFFFF',
          '::placeholder': { color: '#CCCCCC' }
        },
        invalid: {
          color: '#ffb4b4'
        }
      }
    });
    card.mount('#card-element');

    const loader = document.getElementById('loader');
    document.getElementById('fakePaymentForm').onsubmit = async function(e) {
      e.preventDefault();
      loader.style.display = 'block';
      // Validation adresse (identique)
      let valid = true;
      let err = [];
      const prenom = document.getElementById('prenom').value.trim();
      const nom = document.getElementById('nom').value.trim();
      const adresse = document.getElementById('adresse').value.trim();
      const cp = document.getElementById('cp').value.trim();
      const ville = document.getElementById('ville').value.trim();
      const email = document.getElementById('email').value.trim();
      const tel = document.getElementById('tel').value.trim();
      const livraisonSel = document.getElementById('livraison');
      const livraisonTxt = livraisonSel.options[livraisonSel.selectedIndex].text.split('—')[0].trim();
      if (!prenom) { valid = false; err.push('Prénom obligatoire'); }
      if (!nom) { valid = false; err.push('Nom obligatoire'); }
      if (!adresse) { valid = false; err.push('Adresse obligatoire'); }
      if (!cp.match(/^[0-9]{4,10}$/)) { valid = false; err.push('Code postal invalide'); }
      if (!ville) { valid = false; err.push('Ville obligatoire'); }
      if (!email.match(/^\S+@\S+\.\S+$/)) { valid = false; err.push('Email invalide'); }
      if (!tel.match(/^[0-9 +().-]{8,20}$/)) { valid = false; err.push('Téléphone invalide'); }
      const errDiv = document.getElementById('addressError');
      if (!valid) {
        errDiv.style.display = 'block';
        errDiv.textContent = err.join(' · ');
        loader.style.display = 'none';
        return;
      } else {
        errDiv.style.display = 'none';
      }
      // Calcul du total à payer (identique)
      let articles = [];
      if (panier && Array.isArray(panier) && panier.length > 0) {
        articles = panier;
      } else if (article) {
        articles = [article];
      }
      let totalSansLivraison = 0;
      articles.forEach(a => { totalSansLivraison += (a.price || 0) * (a.qty || 1); });
      let remisePromo = 0;
      const hiddenPromo = getHiddenPromo();
      if (promoCode && promoCode.toLowerCase() === hiddenPromo) {
        remisePromo = 0.1 * totalSansLivraison;
      }
      const livraisonPrice = livraisonSel ? parseFloat(livraisonSel.options[livraisonSel.selectedIndex].getAttribute('data-price')) : 4.9;
      let total = totalSansLivraison - remisePromo + livraisonPrice;

      // Appel serveur pour créer PaymentIntent Stripe
      let clientSecret;
      try {
        const res = await fetch('https://printxe3d.onrender.com/create-payment-intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: Math.round(total * 100), currency: 'eur', description: 'Paiement Printxe3D', email })
        });
        const data = await res.json();
        clientSecret = data.clientSecret;
      } catch (err) {
        document.getElementById('card-errors').textContent = 'Erreur serveur paiement.';
        loader.style.display = 'none';
        return;
      }

      // Confirmer le paiement Stripe
      const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
        payment_method: {
          card: card,
          billing_details: { name: prenom + ' ' + nom, email }
        }
      });
      if (error) {
        document.getElementById('card-errors').textContent = error.message;
        loader.style.display = 'none';
        return;
      }
      // Paiement réussi : stocker la commande et rediriger
      let note = '';
      try { note = localStorage.getItem('noteCommande') || ''; } catch(e) {}
      function genCommandeNum() {
        const t = Date.now();
        const r = Math.floor(Math.random()*1000);
        return `PX3D-${t}-${r}`;
      }
      let fiche = {
        prenom, nom, adresse, cp, ville, email, tel,
        livraison: livraisonTxt,
        articles,
        total: total.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' }),
        note: note,
        numeroCommande: genCommandeNum(),
        stripePaymentId: paymentIntent.id
      };
      localStorage.setItem('fiche_commande', JSON.stringify(fiche));
      if (article) {
        localStorage.removeItem('paiement_article');
      } else if (panier && Array.isArray(panier)) {
        localStorage.removeItem('cart');
        localStorage.removeItem('paiement_panier');
      }
      localStorage.removeItem('promoCode');
      localStorage.removeItem('noteCommande');
      loader.style.display = 'none';
      window.location.href = 'fiche-commande.html';
    };
    document.getElementById('backToSite').onclick = function() {
      window.location.href = 'index.html';
    };
  </script>
</body>
</html>


